<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="renderer" content="webkit">
    <title>查看帖子</title>

    <meta name="keywords" content="">
    <meta name="description" content="">

    <!--[if lt IE 9]>
    <meta http-equiv="refresh" content="0;ie.html"/>
    <![endif]-->

    <link rel="shortcut icon" href="/img/favicon.ico">
    <link href="/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/css/font-awesome.min.css?v=4.7.0" rel="stylesheet">
    <link href="/css/plugins/toastr/toastr.min.css" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/style.css?v=4.1.0" rel="stylesheet">
    <link href="/css/custom/custom.css" rel="stylesheet">
    <style>
        .disabled {
            box-shadow: none;
        }
    </style>
</head>
<body class="gray-bg">
<script th:inline="javascript">
    var isAdmin = [[${#session.getAttribute('user').isUserType()}]];
    var topPages = [[${topPostPages}]] || 1;
    var pages = [[${postPages}]] || 1;
    var topPage = 1;
    var page = 1;
</script>
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-12">
            <div class="wrapper wrapper-content animated fadeInRight">
                <div class="ibox-content m-b-sm border-bottom">
                    <div class="p-xs">
                        <div class="pull-left m-r-md">
                            <i class="fa fa-globe text-navy mid-icon"></i>
                        </div>
                        <h2>欢迎来到BBS论坛</h2>
                        <span>你可以自由选择你感兴趣的话题。</span>
                    </div>
                </div>
                <div class="ibox-content m-b-sm border-bottom forum-container">
                    <div th:if="${topPosts.size()>0}" class="forum-title">
                        <div class="pull-right forum-desc">
                            <small th:text="|总帖子数是${topPostSize}|"></small>
                        </div>
                        <h3>主版</h3>
                    </div>
                    <div id="tops">
                        <div th:each="topPost,indexInc:${topPosts}" class="forum-item">
                            <div class="row">
                                <div class="col-sm-10">
                                    <div th:switch="${indexInc.index % 3} " class="forum-icon">
                                        <i th:case="0" class="fa fa-cubes"></i>
                                        <i th:case="1" class="fa fa-bed"></i>
                                        <i th:case="*" class="fa fa-shield"></i>
                                    </div>
                                    <i class="fa fa-vine" style="color: red;" th:if="${topPost.isQuality()}"></i>
                                    <a th:href="@{/Comment/goPostByPostId/{postId}(postId=${topPost.getPostId()})}"
                                       th:text="${topPost.getPostTitle()}"></a>
                                    <div class="forum-sub-title">
                                        <p th:text="${#strings.abbreviate(topPost.getPostContent(),20)}"></p>
                                        <small th:text="${#dates.format(topPost.getRenewDate(),'yyyy-MM-dd HH:mm')}"></small>
                                    </div>
                                    <div class="btn-group" th:if="${#session.getAttribute('user').isUserType()}">
                                        <button th:if="${!topPost.isTop()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:topPost('+${topPost.getPostId()}+')'">
                                            <i class="fa fa-hand-o-left"></i>置顶
                                        </button>
                                        <button th:if="${!topPost.isQuality()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:qualityPost('+${topPost.getPostId()}+')'">
                                            <i class="fa fa-hand-o-up"></i>加精
                                        </button>
                                        <button th:if="${topPost.isTop()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:unTopPost('+${topPost.getPostId()}+')'">
                                            <i class="fa fa-hand-o-right"></i>取消置顶
                                        </button>
                                        <button th:if="${topPost.isQuality()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:unQualityPost('+${topPost.getPostId()}+')'">
                                            <i class="fa fa-hand-o-down"></i>取消加精
                                        </button>
                                    </div>
                                </div>
                                <div class="col-sm-1 forum-info">
                                    <span class="views-number" th:text="${topPost.getLikes()}"></span>
                                    <div>
                                        <small>点赞</small>
                                    </div>
                                </div>
                                <div class="col-sm-1 forum-info">
                                    <span class="views-number" th:text="${topPost.getCollects()}"></span>
                                    <div>
                                        <small>收藏</small>
                                    </div>
                                </div>
                                <!--<div class="col-sm-1 forum-info">-->
                                <!--<span class="views-number"-->
                                <!--th:text="${countComments.get(topPost.getPostId())}"></span>-->
                                <!--<div>-->
                                <!--<small>评论</small>-->
                                <!--</div>-->
                                <!--</div>-->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox-content forum-container" id="content">
                    <div th:if="${posts.size()>0}" class="forum-title">
                        <div class="pull-right forum-desc">
                            <small th:text="|总帖子数是${postSize}|"></small>
                        </div>
                        <h3>副板</h3>
                    </div>
                    <div id="upPosts">
                        <div th:each="post,indexInc:${posts}" class="forum-item">
                            <div class="row">
                                <div class="col-sm-10">
                                    <div th:switch="${indexInc.index%12}" class="forum-icon">
                                        <i th:case="0" class="fa fa-hand-spock-o"></i>
                                        <i th:case="1" class="fa fa-hand-lizard-o"></i>
                                        <i th:case="2" class="fa fa-hand-o-down"></i>
                                        <i th:case="3" class="fa fa-hand-o-left"></i>
                                        <i th:case="4" class="fa fa-hand-o-right"></i>
                                        <i th:case="5" class="fa fa-hand-o-up"></i>
                                        <i th:case="6" class="fa fa-hand-paper-o"></i>
                                        <i th:case="7" class="fa fa-hand-peace-o"></i>
                                        <i th:case="8" class="fa fa-hand-pointer-o"></i>
                                        <i th:case="9" class="fa fa-hand-rock-o"></i>
                                        <i th:case="10" class="fa fa-hand-scissors-o"></i>
                                        <i th:case="*" class="fa fa-hand-stop-o"></i>
                                    </div>
                                    <i class="fa fa-vine" style="color: red;" th:if="${post.isQuality()}"></i>
                                    <a th:href="@{/Comment/goPostByPostId/{postId}(postId=${post.getPostId()})}"
                                       th:text="${post.getPostTitle()}"></a>
                                    <div class="forum-sub-title">
                                        <p th:text="${#strings.abbreviate(post.getPostContent(),20)}"></p>
                                        <small th:text="${#dates.format(post.getRenewDate(),'yyyy-MM-dd HH:mm')}"></small>
                                    </div>
                                    <div class="btn-group" th:if="${#session.getAttribute('user').isUserType()}">
                                        <button th:if="${!post.isTop()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:topPost('+${post.getPostId()}+')'">
                                            <i class="fa fa-hand-o-left"></i>置顶
                                        </button>
                                        <button th:if="${!post.isQuality()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:qualityPost('+${post.getPostId()}+')'">
                                            <i class="fa fa-hand-o-up"></i>加精
                                        </button>
                                        <button th:if="${post.isTop()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:unTopPost('+${post.getPostId()}+')'">
                                            <i class="fa fa-hand-o-right"></i>取消置顶
                                        </button>
                                        <button th:if="${post.isQuality()}" class="btn btn-white btn-xs"
                                                th:onclick="'javascript:unQualityPost('+${post.getPostId()}+')'">
                                            <i class="fa fa-hand-o-down"></i>取消加精
                                        </button>
                                    </div>
                                </div>
                                <div class="col-sm-1 forum-info">
                                    <span class="views-number" th:text="${post.getLikes()}"></span>
                                    <div>
                                        <small>点赞</small>
                                    </div>
                                </div>
                                <div class="col-sm-1 forum-info">
                                    <span class="views-number" th:text="${post.getCollects()}"></span>
                                    <div>
                                        <small>收藏</small>
                                    </div>
                                </div>
                                <!--<div class="col-sm-1 forum-info">-->
                                <!--<span class="views-number" th:text="${countComments.get(post.getPostId())}"></span>-->
                                <!--<div>-->
                                <!--<small>评论</small>-->
                                <!--</div>-->
                                <!--</div>-->
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12" id="morePost">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 全局js -->
<script src="/js/jquery.min.js?v=2.1.4"></script>
<script src="/js/bootstrap.min.js?v=3.3.6"></script>

<!-- 自定义js -->
<script src="/js/hAdmin.js?v=4.1.0"></script>
<script src="/js/index.js"></script>
<script src="/js/custom/commons.js"></script>
<script src="/js/custom/custom.js"></script>

<!-- 第三方插件 -->
<script src="/js/plugins/pace/pace.min.js"></script>
<script src="/js/plugins/toastr/toastr.min.js"></script>
<script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="/js/plugins/layer/layer.min.js"></script>
<script src="/js/plugins/peity/jquery.peity.min.js"></script>
<script>
    var fa = [
        "fa fa-hand-spock-o",
        "fa fa-hand-lizard-o",
        "fa fa-hand-o-down",
        "fa fa-hand-o-left",
        "fa fa-hand-o-right",
        "fa fa-hand-o-up",
        "fa fa-hand-paper-o",
        "fa fa-hand-peace-o",
        "fa fa-hand-pointer-o",
        "fa fa-hand-rock-o",
        "fa fa-hand-scissors-o",
        "fa fa-hand-stop-o"
    ];

    function creatButton() {
        var newButton = document.createElement('button');
        return newButton;
    }

    function showTopPage() {
        var button1 = creatButton();
        button1.textContent = '上一页';
        button1.className = "btn btn-white";
        if (topPage <= 1) {
            button1.className = button1.className + " disabled";
        } else {
            button1.onclick = function (ev) {
                moreTops(topPage - 1);
            };
        }
        var button2 = creatButton();
        button2.className = "btn btn-white";
        button2.textContent = '下一页';
        if (topPage >= topPages) {
            button2.className = button2.className + " disabled";
        } else {
            button2.onclick = function (ev) {
                moreTops(topPage + 1);
            };
        }
        var ul = document.createElement('ul');
        ul.className = "btn-group";
        ul.append(button1, button2);
        var btnTop = document.createElement('div');
        btnTop.className = "text-right";
        btnTop.appendChild(ul);
        var tops = document.getElementById('tops');
        tops.appendChild(btnTop);
    }

    showTopPage();

    function showPostPage() {
        var morePost = document.getElementById('morePost');
        if (page >= pages) {
            morePost.className = 'col-sm-12 hidden';
        } else {
            morePost.className = 'col-sm-12';
            var button1 = creatButton();
            button1.className = 'text-center more-btn btn btn-link col-sm-12';
            button1.innerHTML = '<i class="fa fa-arrow-down"></i> 查看更多';
            button1.onclick = function (ev) {
                morePosts(page + 1);
            };
            morePost.innerHTML = "";
            morePost.appendChild(button1);
        }
    }

    showPostPage();
</script>
<script>
    // 加精帖子
    function qualityPost(postId) {
        $.ajax({
            url: "/Post/qualityPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("加精成功", "加精成功");
                    window.location.reload();
                } else
                    toastr.error("加精失败", "加精失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "加精失败");
            }
        });
    }

    // 取消加精
    function unQualityPost(postId) {
        $.ajax({
            url: "/Post/unQualityPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("加精成功", "加精成功");
                    window.location.reload();
                } else
                    toastr.error("加精失败", "加精失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "加精失败");
            }
        });
    }

    // 置顶帖子
    function topPost(postId) {
        $.ajax({
            url: "/Post/topPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("置顶成功", "置顶成功");
                    window.location.reload();
                } else
                    toastr.error("置顶失败", "置顶失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "置顶失败");
            }
        });
    }

    // 取消置顶
    function unTopPost(postId) {
        $.ajax({
            url: "/Post/unTopPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("加精成功", "加精成功");
                    window.location.reload();
                } else
                    toastr.error("加精失败", "加精失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "加精失败");
            }
        });
    }

    // 分页查看置顶帖
    function moreTops(pageId) {
        if (pageId <= 1)
            pageId = 1;
        if (pageId > topPages)
            pageId = topPages;
        $.ajax({
            url: "/Post/viewTopPosts",
            data: {
                "page": pageId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            success: function (data) {
                if (data.length > 0) {
                    var topHtml = '';
                    for (var i in data) {
                        // console.log(data[i]);
                        topHtml += '<div class="forum-item">';
                        topHtml += '<div class="row">';
                        topHtml += '<div class="col-sm-10">';
                        topHtml += '<div class="forum-icon">';
                        switch (i % 3) {
                            case 0:
                                topHtml += '<i class="fa fa-cubes"></i>';
                                break;
                            case 1:
                                topHtml += '<i class="fa fa-bed"></i>';
                                break;
                            default:
                                topHtml += '<i class="fa fa-shield"></i>';
                                break;
                        }
                        topHtml += '</div>';
                        if (data[i].quality) {
                            topHtml += '<i class="fa fa-vine" style="color: red"></i>';
                        }
                        topHtml += '<a href="/Comment/goPostByPostId/' + data[i].postId + '">' + data[i].postTitle + '</a>';
                        topHtml += '<div class="forum-sub-title">';
                        topHtml += '<p>' + data[i].postContent.substring(0, 20) + '</p>';
                        topHtml += '<small>' + data[i].renewDate + '</small>'
                        topHtml += '</div>';
                        if (isAdmin) {
                            topHtml += '<div class="btn-group">';
                            if (data[i].top) {
                                topHtml += '<button class="btn btn-white btn-xs" onclick="unTopPost(' + data[i].postId + ')">';
                                topHtml += '<i class="fa fa-hand-o-right"></i>取消置顶';
                                topHtml += '</button>';
                            } else {
                                topHtml += '<button class="btn btn-white btn-xs" onclick="topPost(' + data[i].postId + ')">';
                                topHtml += '<i class="fa fa-hand-o-left"></i>置顶';
                                topHtml += '</button>';
                            }
                            if (data[i].quality) {
                                topHtml += '<button class="btn btn-white btn-xs" onclick="unQualityPost(' + data[i].postId + ')">';
                                topHtml += '<i class="fa fa-hand-o-down"></i>取消加精';
                                topHtml += '</button>';
                            } else {
                                topHtml += '<button class="btn btn-white btn-xs" onclick="qualityPost(' + data[i].postId + ')">';
                                topHtml += '<i class="fa fa-hand-o-up"></i>加精';
                                topHtml += '</button>';
                            }
                            topHtml += '</div>';
                        }
                        topHtml += '</div>';
                        topHtml += '<div class="col-sm-1 forum-info">';
                        topHtml += '<span class="views-number">' + data[i].likes + '</span>';
                        topHtml += '<div>';
                        topHtml += '<small>点赞</small>';
                        topHtml += '</div>';
                        topHtml += '</div>';
                        topHtml += '<div class="col-sm-1 forum-info">';
                        topHtml += '<span class="views-number">' + data[i].collects + '</span>';
                        topHtml += '<div>';
                        topHtml += '<small>收藏</small>';
                        topHtml += '</div>';
                        topHtml += '</div>';
                        topHtml += '</div>';
                        topHtml += '</div>';
                    }
                    topPage = pageId;
                    var tops = document.getElementById("tops");
                    tops.innerHTML = topHtml;
                    showTopPage();
                }
            },
            error: function () {
                toastr.error("系统异常", "操作失败");
            }
        });
    }

    // 查看更多帖子
    function morePosts(pageId) {
        if (pageId > pages) {
            page = pages;
            showPostPage();
            return;
        }
        $.ajax({
            url: "/Post/view",
            data: {
                "page": pageId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            success: function (data) {
                if (data.length > 0) {
                    var postHtml = '';
                    for (var i in data) {
                        // console.log(data[i]);
                        postHtml += '<div class="forum-item">';
                        postHtml += '<div class="row">';
                        postHtml += '<div class="col-sm-10">';
                        postHtml += '<div class="forum-icon">';
                        postHtml += '<i class="fa ' + fa[i % 12] + '"></i>';
                        postHtml += '</div>';
                        if (data[i].quality) {
                            postHtml += '<i class="fa fa-vine" style="color: red"></i>';
                        }
                        postHtml += '<a href="/Comment/goPostByPostId/' + data[i].postId + '">' + data[i].postTitle + '</a>';
                        postHtml += '<div class="forum-sub-title">';
                        postHtml += '<p>' + data[i].postContent.substring(0, 20) + '</p>';
                        postHtml += '<small>' + data[i].renewDate + '</small>'
                        postHtml += '</div>';
                        if (isAdmin) {
                            postHtml += '<div class="btn-group">';
                            if (data[i].top) {
                                postHtml += '<button class="btn btn-white btn-xs" onclick="unTopPost(' + data[i].postId + ')">';
                                postHtml += '<i class="fa fa-hand-o-right"></i>取消置顶';
                                postHtml += '</button>';
                            } else {
                                postHtml += '<button class="btn btn-white btn-xs" onclick="topPost(' + data[i].postId + ')">';
                                postHtml += '<i class="fa fa-hand-o-left"></i>置顶';
                                postHtml += '</button>';
                            }
                            if (data[i].quality) {
                                postHtml += '<button class="btn btn-white btn-xs" onclick="unQualityPost(' + data[i].postId + ')">';
                                postHtml += '<i class="fa fa-hand-o-down"></i>取消加精';
                                postHtml += '</button>';
                            } else {
                                postHtml += '<button class="btn btn-white btn-xs" onclick="qualityPost(' + data[i].postId + ')">';
                                postHtml += '<i class="fa fa-hand-o-up"></i>加精';
                                postHtml += '</button>';
                            }
                            postHtml += '</div>';
                        }
                        postHtml += '</div>';
                        postHtml += '<div class="col-sm-1 forum-info">';
                        postHtml += '<span class="views-number">' + data[i].likes + '</span>';
                        postHtml += '<div>';
                        postHtml += '<small>点赞</small>';
                        postHtml += '</div>';
                        postHtml += '</div>';
                        postHtml += '<div class="col-sm-1 forum-info">';
                        postHtml += '<span class="views-number">' + data[i].collects + '</span>';
                        postHtml += '<div>';
                        postHtml += '<small>收藏</small>';
                        postHtml += '</div>';
                        postHtml += '</div>';
                        postHtml += '</div>';
                        postHtml += '</div>';
                    }
                    page = pageId;
                    var upPosts = document.getElementById('upPosts');
                    upPosts.innerHTML += postHtml;
                    showPostPage();
                }
            },
            error: function () {
                toastr.error("系统异常", "操作失败");
            }
        })
    }
</script>
</body>
</html>

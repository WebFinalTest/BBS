<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="renderer" content="webkit">
  <title th:text="${post.getPostTitle()}"></title>

  <meta name="keywords" content="">
  <meta name="description" content="">

  <!--[if lt IE 9]>
  <meta http-equiv="refresh" content="0;ie.html"/>
  <![endif]-->

  <link rel="shortcut icon" href="/img/favicon.ico">

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.css?v=4.4.0">
  <link rel="stylesheet" href="/css/plugins/iCheck/custom.css">
  <link rel="stylesheet" href="/css/plugins/summernote/summernote.css">
  <link rel="stylesheet" href="/css/plugins/summernote/summernote-bs3.css">
  <link rel="stylesheet" href="/css/animate.css">
  <link rel="stylesheet" href="/css/style.css?v=4.1.0">
  <link rel="stylesheet" href="/css/custom/custom.css">
  <link rel="stylesheet" href="/css/plugins/toastr/toastr.min.css">
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content  animated fadeInRight">
  <div class="row">
    <div class="col-sm-12">
      <div class="ibox">
        <div class="ibox-title text-center" th:text="${post.getPostTitle()}"></div>
        <div class="social-avatar">
          <div class="media-body">
            <small th:text="${postUserName}+' 发表于'+${#dates.format(post.getCreateDate(), 'yyyy-MM-dd HH:mm')}"
                   class="text-muted">
            </small>
          </div>
        </div>
        <div class="row social-body">
          <div class="col-sm-10" th:if="${!post.isPostType()}">
            <p th:text="${post.getPostContent()}"></p>
          </div>
          <div class="col-sm-9" th:if="${post.isPostType()}">
            <p th:text="${post.getPostContent()}"></p>
          </div>
          <div class="col-sm-1 forum-info" th:if="${post.isPostType()}">
            <span class="views-number" th:if="${post.adoptCommentId==null}"
                  th:text="${post.getPostPoints()}">
            </span>
            <div th:if="${post.adoptCommentId==null}">
              <small>积分</small>
            </div>
            <span class="views-number" th:if="${post.adoptCommentId!=null}">
                   <i class="fa fa-check-square-o"></i>
                 </span>
            <div th:if="${post.adoptCommentId!=null}">
              <small>已采纳</small>
            </div>
          </div>
          <div class="col-sm-1 forum-info">
            <span class="views-number" th:text="${post.getLikes()}"></span>
            <div>
              <small>点赞</small>
            </div>
          </div>
          <div class="col-sm-1 forum-info">
            <span class="views-number" th:text="${post.getCollects()}"></span>
            <div>
              <small>收藏</small>
            </div>
          </div>
          <div class="col-sm-12 btn-group">
            <button th:if="${!isLikePost}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:likePost('+${post.getPostId()}+')'">
              <i class="fa fa-thumbs-up"></i>赞
            </button>
            <button th:if="${isLikePost}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:unLikePost('+${post.getPostId()}+')'">
              <i class="fa fa-thumbs-down"></i>取消赞
            </button>
            <button th:if="${!isCollectPost}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:collectPost('+${post.getPostId()}+')'">
              <i class="fa fa-star"></i>收藏
            </button>
            <button th:if="${isCollectPost}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:unCollectPost('+${post.getPostId()}+')'">
              <i class="fa fa-star"></i>取消收藏
            </button>
            <button class="btn btn-white btn-xs" th:onclick="'javscript:showFooter(\'\')'">
              <i class="fa fa-comment"></i>评论
            </button>
            <span th:if="${#session.getAttribute('user').isUserType()}">
              <button th:if="${!post.isTop()}" class="btn btn-white btn-xs"
                      th:onclick="'javascript:topPost('+${post.getPostId()}+')'">
                  <i class="fa fa-hand-o-left"></i>置顶
              </button>
              <button th:if="${!post.isQuality()}" class="btn btn-white btn-xs"
                      th:onclick="'javascript:qualityPost('+${post.getPostId()}+')'">
                  <i class="fa fa-hand-o-up"></i>加精
              </button>
              <button th:if="${post.isTop()}" class="btn btn-white btn-xs"
                      th:onclick="'javascript:unTopPost('+${post.getPostId()}+')'">
                  <i class="fa fa-hand-o-right"></i>取消置顶
              </button>
              <button th:if="${post.isQuality()}" class="btn btn-white btn-xs"
                      th:onclick="'javascript:unQualityPost('+${post.getPostId()}+')'">
                  <i class="fa fa-hand-o-down"></i>取消加精
              </button>
              <button class="btn btn-danger btn-xs"
                      th:onclick="'javascript:deletePost('+${post.getPostId()}+')'">
                  <i class="fa fa-trash"></i>删除
              </button>
            </span>
          </div>
        </div>
        <div class="social-footer hidden" id="showFooter">
          <div class="social-comment">
            <div class="media-body">
              <div class="col-sm-12">
                <textarea id="postContent" placeholder="填写评论" class="textarea"></textarea>
              </div>
              <div class="col-sm-1">
                <button th:onclick="'javascript:commentPost('+${post.getPostId()}+')'"
                        class="btn btn-primary">评论
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div th:if="${post.getAdoptCommentId()!=null}" class="social-feed-box">
        <div class="social-avatar">
          <div class="media-body">
            <small class="text-muted"
                   th:text="${commentUserNames.get(adoptComment.getUserId())}+' 发表于'+${#dates.format(adoptComment.getCreateDate(),'yyyy-MM-dd HH:mm')}">
            </small>
          </div>
        </div>
        <div class="row social-body">
          <div class="col-sm-11">
            <p th:text="${adoptComment.getCommentContent()}"></p>
          </div>
          <div class="col-sm-1 forum-info">
            <span class="views-number" th:text="${adoptComment.getLikes()}"></span>
            <div>
              <small>点赞</small>
            </div>
          </div>
          <div class="col-sm-12 btn-group">
            <button th:if="${!isLikeComment.get(adoptComment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:likeComment('+${adoptComment.getCommentId()}+')'">
              <i class="fa fa-thumbs-up"></i>赞
            </button>
            <button th:if="${isLikeComment.get(adoptComment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:unLikeComment('+${adoptComment.getCommentId()}+')'">
              <i class="fa fa-thumbs-down"></i>取消赞
            </button>
            <button th:onclick="'javascript:showFooter(\'Adopt\')'" class="btn btn-white btn-xs">
              <i class="fa fa-adoptComment"></i>评论
            </button>
            <a th:href="'/Comment/goFloorComment/'+${adoptComment.getCommentId()}" class="btn btn-primary btn-xs">
              <i class="fa fa-ellipsis-v"></i>查看回复
            </a>
          </div>
        </div>
        <div class="social-footer hidden" id="showFooterAdopt">
          <div class="social-comment">
            <div class="media-body">
              <div class="col-sm-12">
                <textarea th:id="commentContentAdopt" placeholder="填写评论" class="textarea"></textarea>
              </div>
              <div class="col-sm-1">
                <button class="btn btn-primary"
                        th:onclick="'javascript:commentComment('+${adoptComment.getCommentId()}+',\'Adopt\')'">评论
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div th:each="comment,indexInc:${comments}" class="social-feed-box">
        <div th:if="${post.getAdoptCommentId()==null||post.getAdoptCommentId()!=comment.getCommentId()}"
             class="social-avatar">
          <div class="media-body">
            <small th:text="${commentUserNames.get(comment.getUserId())}+' 发表于'+${#dates.format(comment.getCreateDate(),'yyyy-MM-dd HH:mm')}"
                   class="text-muted"></small>
          </div>
        </div>
        <div th:if="${post.getAdoptCommentId()==null||post.getAdoptCommentId()!=comment.getCommentId()}"
             class="row social-body">
          <div class="col-sm-11">
            <p th:text="${comment.getCommentContent()}"></p>
          </div>
          <div class="col-sm-1 forum-info">
            <span class="views-number" th:text="${comment.getLikes()}"></span>
            <div>
              <small>点赞</small>
            </div>
          </div>
          <div class="col-sm-12 btn-group">
            <button th:if="${!isLikeComment.get(comment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:likeComment('+${comment.getCommentId()}+')'">
              <i class="fa fa-thumbs-up"></i>赞
            </button>
            <button th:if="${isLikeComment.get(comment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:unLikeComment('+${comment.getCommentId()}+')'">
              <i class="fa fa-thumbs-down"></i>取消赞
            </button>
            <button th:onclick="'javascript:showFooter('+${indexInc.index}+')'" class="btn btn-white btn-xs">
              <i class="fa fa-comment"></i>评论
            </button>
            <a th:href="'/Comment/goFloorComment/'+${comment.getCommentId()}" class="btn btn-primary btn-xs">
              <i class="fa fa-ellipsis-v"></i>查看回复
            </a>
            <button class="btn btn-info btn-xs"
                    th:if="${post.isPostType() && post.getAdoptCommentId() == null && post.getUserId() == #session.getAttribute('user').getUserId()}"
                    th:onclick="'javascript:adoptComment('+${comment.getCommentId()}+','+${post.getPostId()}+')'">
              <i class="fa fa-check-square-o"></i>采纳评论
            </button>
            <button
                th:if="${#session.getAttribute('user').isUserType() || #session.getAttribute('user').getUserId() == post.getUserId()}"
                class="btn btn-danger btn-xs"
                th:onclick="'javascript:deleteComment('+${comment.getCommentId()}+')'">
              <i class="fa fa-trash"></i>删除
            </button>
          </div>
        </div>
        <div th:if="${post.getAdoptCommentId()==null||post.getAdoptCommentId()!=comment.getCommentId()}"
             class="social-footer hidden" th:id="|showFooter${indexInc.index}|">
          <div class="social-comment">
            <div class="media-body">
              <div class="col-sm-12">
                <textarea th:id="|commentContent${indexInc.index}|" placeholder="填写评论"
                          class="textarea"></textarea>
              </div>
              <div class="col-sm-1">
                <button
                    th:onclick="'javascript:commentComment('+${comment.getCommentId()}+','+${indexInc.index}+')'"
                    class="btn btn-primary">评论
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 全局js -->
<script src="/js/jquery.min.js?v=2.1.4"></script>
<script src="/js/bootstrap.min.js?v=3.3.6"></script>

<!-- 自定义js -->
<script src="/js/hAdmin.js?v=4.1.0"></script>
<script src="/js/index.js"></script>
<script src="/js/custom/commons.js"></script>
<script src="/js/custom/custom.js"></script>

<!-- 第三方插件 -->
<script src="/js/plugins/pace/pace.min.js"></script>
<script src="/js/plugins/toastr/toastr.min.js"></script>
<script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="/js/plugins/layer/layer.min.js"></script>
<script src="/js/plugins/toastr/toastr.min.js"></script>
<script>
    // Post
    var showPost = 0;

    function reload() {
        window.location.reload();
    }

    function newHref() {
        window.location.href = '/Post/view';
    }

    // 给帖子点赞
    function likePost(postId) {
        $.ajax({
            url: "/Like/likePost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("点赞成功", "点赞成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("你已经点赞过了", "点赞失败");
            },
            error: function () {
                toastr.error("你已经点赞过了", "点赞失败");
            }
        });
    }

    // 取消帖子点赞
    function unLikePost(postId) {
        $.ajax({
            url: "/Like/unLikePost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("取消点赞成功", "取消点赞成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("你没有点赞过", "取消点赞失败");
                setTimeout(reload, 500);
            },
            error: function () {
                toastr.error("系统异常，请重试", "取消点赞失败");
            }
        });
    }

    // 收藏帖子
    function collectPost(postId, favoritesId) {
        $.ajax({
            url: "/Collect/createCollect",
            data: {
                "postId": postId
                // "favorites": favoritesId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("收藏成功", "收藏成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("你已经收藏过了", "收藏失败");
            },
            error: function () {
                toastr.error("收藏失败，系统异常", "收藏失败");
            }
        });
    }

    // 取消帖子收藏
    function unCollectPost(postId, favoritesId) {
        $.ajax({
            url: "/Collect/deleteCollect",
            data: {
                "postId": postId
                // "favorites": favoritesId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("取消收藏成功", "取消收藏成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("你没有收藏过", "取消收藏失败");
            },
            error: function () {
                toastr.error("取消收藏失败，系统异常", "取消收藏失败");
            }
        });
    }

    var ani = ["fadeInLeftBig", "fadeInRightBig", "rollIn"];

    // 展示帖子评论框
    function showFooter(footerId) {
        var footerPost = document.getElementById("showFooter" + footerId);
        var className = "social-footer";
        if (showPost % 2 === 0) {
            footerPost.className = className + " " + "animated" + " " + ani[showPost % 3];
        } else
            footerPost.className = className + " " + "hidden";
        showPost++;
    }

    // 删除帖子
    function deletePost(postId) {
        $.ajax({
            url: "/Post/deletePost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("删除成功", "删除成功");
                    setTimeout(newHref, 500);
                } else
                    toastr.error("删除失败", "删除失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "删除失败");
            }
        });
    }

    // 提交帖子的评论
    function commentPost(postId) {
        $.ajax({
            url: "/Comment/create",
            data: {
                "postId": postId,
                "commentContent": $("#postContent").val()
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("评论成功", "评论成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("评论失败", "评论失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "评论失败");
            }
        });
    }

    // 加精帖子
    function qualityPost(postId) {
        $.ajax({
            url: "/Post/qualityPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("加精成功", "加精成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("加精失败", "加精失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "加精失败");
            }
        });
    }

    // 取消加精
    function unQualityPost(postId) {
        $.ajax({
            url: "/Post/unQualityPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("取消加精成功", "取消加精成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("取消加精失败", "取消加精失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "取消加精失败");
            }
        });
    }

    // 置顶帖子
    function topPost(postId) {
        $.ajax({
            url: "/Post/topPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("置顶成功", "置顶成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("置顶失败", "置顶失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "置顶失败");
            }
        });
    }

    // 取消置顶
    function unTopPost(postId) {
        $.ajax({
            url: "/Post/unTopPost",
            data: {
                "postId": postId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("取消置顶成功", "取消置顶成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("取消置顶失败", "取消置顶失败");
            },
            error: function () {
                toastr.error("系统繁忙，请重试", "取消置顶失败");
            }
        });
    }

    // Comment
    // 给评论点赞
    function likeComment(commentId) {
        $.ajax({
            url: "/Like/likeComment",
            data: {
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success")
                    toastr.success("点赞成功", "点赞成功");
                else
                    toastr.error("你已经点赞过了", "点赞失败");
                setTimeout(reload, 500);
            },
            error: function () {
                toastr.error("系统异常，请重试", "点赞失败");
            }
        });
    }

    // 取消评论点赞
    function unLikeComment(commentId) {
        $.ajax({
            url: "/Like/unLikeComment",
            data: {
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("取消点赞成功", "取消点赞成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("你没有点赞过", "取消点赞失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "取消点赞失败");
            }
        });
    }

    // 删除评论
    function deleteComment(commentId) {
        $.ajax({
            url: "/Comment/deleteComment",
            data: {
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("删除成功", "删除成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("删除失败", "删除失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "删除失败");
            }
        });
    }

    // 提交评论的评论
    function commentComment(commentId, indexId) {
        $.ajax({
            url: "/Comment/create",
            data: {
                "replyId": commentId,
                "commentContent": $('#commentContent' + indexId).val()
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("评论成功", "评论成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("评论失败", "评论失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "评论失败");
            }
        });
    }

    // 采纳评论
    function adoptComment(commentId, postId) {
        $.ajax({
            url: "/Post/adoptComment",
            data: {
                "postId": postId,
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("采纳成功", "采纳成功");
                    setTimeout(reload, 500);
                } else
                    toastr.error("评论失败", "评论失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "评论失败");
            }
        });
    }
</script>
</div>
</body>
</html>
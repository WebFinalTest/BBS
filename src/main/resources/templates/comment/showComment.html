<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="renderer" content="webkit">
  <title th:text="comments"></title>

  <meta name="keywords" content="">
  <meta name="description" content="">

  <!--[if lt IE 9]>
  <meta http-equiv="refresh" content="0;ie.html"/>
  <![endif]-->

  <link rel="shortcut icon" href="/img/favicon.ico">

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.css?v=4.4.0">
  <link rel="stylesheet" href="/css/plugins/iCheck/custom.css">
  <link rel="stylesheet" href="/css/plugins/summernote/summernote.css">
  <link rel="stylesheet" href="/css/plugins/summernote/summernote-bs3.css">
  <link rel="stylesheet" href="/css/animate.css">
  <link rel="stylesheet" href="/css/style.css?v=4.1.0">
  <link rel="stylesheet" href="/css/custom/custom.css">
  <link rel="stylesheet" href="/css/plugins/toastr/toastr.min.css">
</head>
<body class="gray-bg">
<script th:inline="javascript">
  var postId= [[${floorComment.getPostId()}]];
  var floorCommentId = [[${floorComment.getCommentId()}]];
</script>
<div class="wrapper wrapper-content  animated fadeInRight">
  <div class="row">
    <div class="col-sm-12">
      <div class="social-feed-box">
        <div class="social-avatar">
          <div class="media-body">
            <small class="text-muted"
                th:text="${commentUserNames.get(floorComment.getUserId())}+' 发表于'+${#dates.format(floorComment.getCreateDate(),'yyyy-MM-dd HH:mm')}">
            </small>
          </div>
        </div>
        <div class="row social-body">
          <div class="col-sm-11">
            <p th:text="${floorComment.getCommentContent()}"></p>
          </div>
          <div class="col-sm-1 forum-info">
            <span class="views-number" th:text="${floorComment.getLikes()}"></span>
            <div>
              <small>点赞</small>
            </div>
          </div>
          <div class="col-sm-12 btn-group">
            <button th:if="${!isLikeComment.get(floorComment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:likeComment('+${floorComment.getCommentId()}+')'">
              <i class="fa fa-thumbs-up"></i>赞
            </button>
            <button th:if="${isLikeComment.get(floorComment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:unLikeComment('+${floorComment.getCommentId()}+')'">
              <i class="fa fa-thumbs-up"></i>取消赞
            </button>
            <button th:onclick="'javascript:showFooter(\'\')'" class="btn btn-white btn-xs">
              <i class="fa fa-comment"></i>评论
            </button>
            <button th:if="${#session.getAttribute('user').isUserType()}" class="btn btn-danger btn-xs"
                    th:onclick="'javascript:deleteComment('+${floorComment.getCommentId()}+')'">
              <i class="fa fa-trash"></i>删除
            </button>
          </div>
        </div>
        <div class="social-footer hidden" id="showFooter">
          <div class="social-comment">
            <div class="media-body">
              <div class="col-sm-12">
                <textarea th:id="commentContent" placeholder="填写评论"
                          class="textarea"></textarea>
              </div>
              <div class="col-sm-1">
                <button th:onclick="'javascript:commentComment('+${floorComment.getCommentId()}+',\'\')'"
                        class="btn btn-primary">评论
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-12">
      <div class="social-feed-box" th:each="comment,indexInc:${comments}">
        <div class="social-avatar">
          <div class="media-body">
            <small class="text-muted"
                th:text="${commentUserNames.get(comment.getUserId())}+' 发表于'+${#dates.format(comment.getCreateDate(),'yyyy-MM-dd HH:mm')}">
            </small>
          </div>
        </div>
        <div class="social-body row">
          <div class="col-sm-11">
            <b th:if="${comment.getReplyId() != floorComment.getCommentId()}" style="color:rgb(200,200,200)"
               th:text="'回复：'+${replyComments[comment.getReplyId()]}"></b>
            <p th:text="${comment.getCommentContent()}"></p>
          </div>
          <div class="col-sm-1 forum-info">
            <span class="views-number" th:text="${comment.getLikes()}"></span>
            <div>
              <small>点赞</small>
            </div>
          </div>
          <div class="col-sm-12 btn-group">
            <button th:if="${!isLikeComment.get(comment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:likeComment('+${comment.getCommentId()}+')'">
              <i class="fa fa-thumbs-up"></i>赞
            </button>
            <button th:if="${isLikeComment.get(comment.getCommentId())}" class="btn btn-white btn-xs"
                    th:onclick="'javascript:unLikeComment('+${comment.getCommentId()}+')'">
              <i class="fa fa-thumbs-up"></i>取消赞
            </button>
            <button th:onclick="'javascript:showFooter('+${indexInc.index}+')'" class="btn btn-white btn-xs">
              <i class="fa fa-comment"></i>评论
            </button>
            <button th:if="${#session.getAttribute('user').isUserType()}" class="btn btn-danger btn-xs"
                    th:onclick="'javascript:deleteComment('+${comment.getCommentId()}+')'">
              <i class="fa fa-trash"></i>删除
            </button>
          </div>
        </div>
        <div class="social-footer hidden" th:id="|showFooter${indexInc.index}|">
          <div class="social-comment">
            <div class="media-body">
              <div class="col-sm-12">
                <textarea th:id="|commentContent${indexInc.index}|" placeholder="填写评论"
                          class="textarea"></textarea>
              </div>
              <div class="col-sm-1">
                <button th:onclick="'javascript:commentComment('+${comment.getCommentId()}+','+${indexInc.index}+')'"
                        class="btn btn-primary">评论
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 全局js -->
<script src="/js/jquery.min.js?v=2.1.4"></script>
<script src="/js/bootstrap.min.js?v=3.3.6"></script>

<!-- 自定义js -->
<script src="/js/hAdmin.js?v=4.1.0"></script>
<script src="/js/index.js"></script>
<script src="/js/custom/commons.js"></script>
<script src="/js/custom/custom.js"></script>

<!-- 第三方插件 -->
<script src="/js/plugins/pace/pace.min.js"></script>
<script src="/js/plugins/toastr/toastr.min.js"></script>
<script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="/js/plugins/layer/layer.min.js"></script>
<script src="/js/plugins/toastr/toastr.min.js"></script>
<script>
    var ani = ["fadeInLeftBig", "fadeInRightBig", "rollIn"];

    var showPost = 0;
    var past = null;

    function reload() {
        window.location.reload();
    }
    // 展示帖子评论框
    function showFooter(footerId) {
        if (past !== null && showPost % 2 === 1)
            showPost++;
        past = footerId;
        var footerPost = document.getElementById("showFooter" + footerId);
        var className = "social-footer";
        if (showPost % 2 === 0) {
            footerPost.className = className + " " + "animated" + " " + ani[showPost % 3];
        } else
            footerPost.className = className + " " + "hidden";
        showPost++;
    }

    // 提交评论的评论
    function commentComment(commentId, indexId) {
        $.ajax({
            url: "/Comment/create",
            data: {
                "replyId": commentId,
                "commentContent": $('#commentContent' + indexId).val()
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("评论成功", "评论成功");

                        window.location.reload();
                } else
                    toastr.error("评论失败", "评论失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "评论失败");
            }
        });
    }

    // 给评论点赞
    function likeComment(commentId) {
        $.ajax({
            url: "/Like/likeComment",
            data: {
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success")
                    toastr.success("点赞成功", "点赞成功");
                else
                    toastr.error("你已经点赞过了", "点赞失败");
                window.location.reload();
            },
            error: function () {
                toastr.error("系统异常，请重试", "点赞失败");
            }
        });
    }

    // 取消评论点赞
    function unLikeComment(commentId) {
        $.ajax({
            url: "/Like/unLikeComment",
            data: {
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            async: true,
            success: function (result) {
                if (result.message === "success")
                    toastr.success("取消点赞成功", "取消点赞成功");
                else
                    toastr.error("你没有点赞过", "取消点赞失败");
                window.location.reload();
            },
            error: function () {
                toastr.error("系统异常，请重试", "取消点赞失败");
            }
        });
    }

    // 删除评论
    function deleteComment(commentId) {
        $.ajax({
            url: "/Comment/deleteComment",
            data: {
                "commentId": commentId
            },
            type: "POST",
            dataType: "json",
            timeout: 3000,
            async: true,
            success: function (result) {
                if (result.message === "success") {
                    toastr.success("删除成功", "删除成功");
                    if(commentId === floorCommentId)
                        setTimeout(window.location.href="/Comment/goPostByPostId/"+postId, 500);
                    else
                        setTimeout(reload, 500);
                } else
                    toastr.error("删除失败", "删除失败");
            },
            error: function () {
                toastr.error("系统异常，请重试", "删除失败");
            }
        });
    }
</script>
</body>
</html>